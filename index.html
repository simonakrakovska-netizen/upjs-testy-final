<!DOCTYPE html>
<html lang="sk">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>UPJ≈† BioChem Testy</title>
  <style>
    :root{
      --bg1:#0b1020;
      --bg2:#0b2a6b;
      --card:#0f1730cc;
      --card2:#0f1730;
      --text:#eaf0ff;
      --muted:#b8c6ff;
      --accent:#3b82f6;
      --accent2:#60a5fa;
      --good:#22c55e;
      --bad:#ef4444;
      --warn:#f59e0b;
      --border:#22305d;
      --shadow: 0 18px 40px rgba(0,0,0,.35);
      --radius: 18px;
    }
    *{box-sizing:border-box}
    body{
      margin:0;
      font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Arial, "Helvetica Neue", sans-serif;
      color:var(--text);
      background:
        radial-gradient(1200px 600px at 20% -10%, rgba(96,165,250,.35), transparent 60%),
        radial-gradient(800px 500px at 95% 10%, rgba(59,130,246,.25), transparent 55%),
        linear-gradient(160deg, var(--bg1), var(--bg2));
      min-height:100vh;
      padding:18px 14px 40px;
    }
    .wrap{max-width:980px;margin:0 auto}
    .topbar{
      display:flex; gap:12px; align-items:center; justify-content:space-between;
      padding:14px 16px;
      border:1px solid rgba(255,255,255,.08);
      background:linear-gradient(180deg, rgba(15,23,48,.78), rgba(15,23,48,.55));
      border-radius: var(--radius);
      box-shadow: var(--shadow);
      position: sticky; top: 10px; z-index: 10;
      backdrop-filter: blur(10px);
    }
    .brand{
      display:flex; gap:12px; align-items:center; min-width: 0;
    }
    .logo{
      width:42px;height:42px;border-radius:14px;
      background: radial-gradient(circle at 30% 30%, rgba(96,165,250,.9), rgba(59,130,246,.55));
      border:1px solid rgba(255,255,255,.18);
      display:grid; place-items:center;
      box-shadow: 0 12px 25px rgba(59,130,246,.25);
      flex:0 0 auto;
    }
    .logo span{font-weight:800; letter-spacing:.5px}
    .brand h1{
      font-size:16px; margin:0; line-height:1.15; white-space:nowrap; overflow:hidden; text-overflow:ellipsis;
    }
    .brand p{
      margin:0; font-size:12px; color:var(--muted); white-space:nowrap; overflow:hidden; text-overflow:ellipsis;
    }

    .pill{
      display:inline-flex; gap:10px; align-items:center;
      padding:8px 10px;
      border:1px solid rgba(255,255,255,.10);
      background: rgba(255,255,255,.06);
      border-radius: 999px;
      color: var(--text);
      font-size: 12px;
    }
    .toggle{
      display:flex; align-items:center; gap:8px;
      user-select:none;
    }
    .switch{
      width:44px; height:26px; border-radius:999px;
      border:1px solid rgba(255,255,255,.20);
      background: rgba(0,0,0,.25);
      position:relative;
      flex:0 0 auto;
    }
    .knob{
      width:22px; height:22px; border-radius:999px;
      background: linear-gradient(180deg, #fff, #cfe0ff);
      position:absolute; top:1px; left:1px;
      transition: all .2s ease;
      box-shadow: 0 10px 20px rgba(0,0,0,.35);
    }
    .switch.on{ background: rgba(59,130,246,.35); }
    .switch.on .knob{ left: 21px; }

    .grid{
      display:grid;
      grid-template-columns: 1fr;
      gap:14px;
      margin-top:14px;
    }
    @media(min-width:900px){
      .grid{ grid-template-columns: 380px 1fr; align-items:start;}
    }

    .card{
      border:1px solid rgba(255,255,255,.10);
      background: linear-gradient(180deg, rgba(15,23,48,.80), rgba(15,23,48,.55));
      border-radius: var(--radius);
      box-shadow: var(--shadow);
      overflow:hidden;
      backdrop-filter: blur(10px);
    }
    .card .hd{
      padding:14px 16px;
      border-bottom: 1px solid rgba(255,255,255,.08);
      display:flex; align-items:center; justify-content:space-between; gap:10px;
    }
    .card .hd h2{margin:0; font-size:14px}
    .card .bd{padding:14px 16px}

    .btn{
      border:1px solid rgba(255,255,255,.14);
      background: rgba(255,255,255,.06);
      color: var(--text);
      padding: 10px 12px;
      border-radius: 12px;
      cursor:pointer;
      font-weight:600;
      transition: transform .06s ease, background .15s ease, border .15s ease;
    }
    .btn:hover{ background: rgba(255,255,255,.10); }
    .btn:active{ transform: translateY(1px); }
    .btn.primary{
      background: linear-gradient(180deg, rgba(59,130,246,.95), rgba(37,99,235,.95));
      border-color: rgba(255,255,255,.18);
      box-shadow: 0 16px 30px rgba(59,130,246,.25);
    }
    .btn.primary:hover{ filter: brightness(1.04); }
    .btn.ghost{ background: transparent; }
    .btn.danger{ background: rgba(239,68,68,.16); border-color: rgba(239,68,68,.35); }
    .btn.good{ background: rgba(34,197,94,.16); border-color: rgba(34,197,94,.35); }
    .btnRow{ display:flex; gap:10px; flex-wrap:wrap; }

    .list{
      display:flex; flex-direction:column; gap:8px;
    }
    .item{
      display:flex; align-items:center; justify-content:space-between; gap:10px;
      border:1px solid rgba(255,255,255,.10);
      background: rgba(255,255,255,.04);
      padding:10px 12px;
      border-radius: 14px;
      cursor:pointer;
      transition: background .15s ease, border .15s ease;
    }
    .item:hover{ background: rgba(255,255,255,.08); border-color: rgba(255,255,255,.16); }
    .item .t{ font-weight:700; font-size:13px; }
    .item .s{ font-size:12px; color: var(--muted); }

    .crumbs{ font-size:12px; color: var(--muted); }
    .crumbs b{ color: var(--text); }

    .progress{
      height:10px; border-radius:999px;
      background: rgba(255,255,255,.10);
      border:1px solid rgba(255,255,255,.10);
      overflow:hidden;
    }
    .bar{
      height:100%;
      width:0%;
      background: linear-gradient(90deg, rgba(96,165,250,.95), rgba(59,130,246,.95));
      transition: width .2s ease;
    }

    .qTitle{ margin:0 0 8px; font-size:15px; line-height:1.35; }
    .metaRow{ display:flex; gap:10px; align-items:center; justify-content:space-between; flex-wrap:wrap; margin: 8px 0 12px; }
    .metaRow .pill{ font-size:12px; }

    .choices{
      display:grid;
      grid-template-columns: 1fr;
      gap:10px;
      margin-top:10px;
    }
    @media(min-width:720px){
      .choices{ grid-template-columns: 1fr 1fr; }
    }

    .choice{
      display:flex; gap:10px; align-items:flex-start;
      border:1px solid rgba(255,255,255,.12);
      background: rgba(255,255,255,.04);
      padding:10px 12px;
      border-radius: 14px;
    }
    .choice input{ margin-top:3px; transform: scale(1.15); }
    .choice .lbl{ font-weight:800; width: 22px; flex: 0 0 auto; color: var(--accent2); }
    .choice .tx{ font-size:13px; color: var(--text); line-height:1.25; }
    .choice.small{ opacity: .65; }

    .hr{ height:1px; background: rgba(255,255,255,.10); margin: 14px 0; }

    .resultBox{
      border:1px solid rgba(255,255,255,.12);
      background: rgba(0,0,0,.18);
      padding:12px 12px;
      border-radius: 14px;
    }
    .resultGrid{
      display:grid;
      grid-template-columns: 1fr;
      gap:10px;
    }
    @media(min-width:720px){ .resultGrid{ grid-template-columns: 1fr 1fr; } }

    .stat{
      border:1px solid rgba(255,255,255,.10);
      background: rgba(255,255,255,.04);
      padding:10px 12px;
      border-radius: 14px;
    }
    .stat .k{ font-size:12px; color: var(--muted); }
    .stat .v{ font-size:18px; font-weight:900; margin-top:4px; }

    .hint{
      font-size:12px; color: var(--muted); line-height:1.35;
    }
    .badge{
      display:inline-block;
      padding:4px 8px;
      border-radius: 999px;
      font-size:11px;
      border:1px solid rgba(255,255,255,.16);
      background: rgba(255,255,255,.06);
      color: var(--text);
    }
    .badge.good{ border-color: rgba(34,197,94,.35); background: rgba(34,197,94,.12); }
    .badge.bad{ border-color: rgba(239,68,68,.35); background: rgba(239,68,68,.12); }
    .badge.warn{ border-color: rgba(245,158,11,.35); background: rgba(245,158,11,.12); }

    .footer{
      text-align:center; margin-top:14px; color: rgba(255,255,255,.65); font-size:12px;
    }
    .kbd{
      font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace;
      font-size: 11px;
      background: rgba(0,0,0,.25);
      border: 1px solid rgba(255,255,255,.12);
      border-radius: 10px;
      padding: 2px 6px;
      color: rgba(255,255,255,.85);
    }
  </style>
</head>

<body>
  <div class="wrap">
    <div class="topbar">
      <div class="brand">
        <div class="logo"><span>U</span></div>
        <div style="min-width:0">
          <h1>UPJ≈† BioChem Testy</h1>
          <p>Predmet ‚Üí T√©ma ‚Üí Test ¬∑ bodovanie podƒæa spr√°vnych mo≈ænost√≠</p>
        </div>
      </div>

      <div class="pill toggle" title="Prep√≠na medzi 8 mo≈ænos≈•ami (A‚ÄìH) a 4 mo≈ænos≈•ami (A‚ÄìD)">
        <span id="modeLabel">Re≈æim: 8 mo≈ænost√≠</span>
        <div id="modeSwitch" class="switch on" role="switch" aria-checked="true" tabindex="0">
          <div class="knob"></div>
        </div>
      </div>
    </div>

    <div class="grid">
      <!-- LEFT: NAV -->
      <div class="card" id="navCard">
        <div class="hd">
          <h2 id="navTitle">Menu</h2>
          <span class="badge" id="navBadge">Pripraven√©</span>
        </div>
        <div class="bd">
          <div class="crumbs" id="crumbs">Si tu: <b>Predmet</b></div>
          <div class="hr"></div>

          <div id="screenSubject" class="list"></div>
          <div id="screenThemes" class="list" style="display:none"></div>

          <div class="hr"></div>
          <div class="btnRow">
            <button class="btn ghost" id="backBtn" onclick="goBack()" style="display:none">‚¨Ö Sp√§≈•</button>
            <button class="btn danger" id="resetBtn" onclick="hardReset()">Reset</button>
          </div>
          <div style="margin-top:10px" class="hint">
            Tip: ak chce≈° ‚Äûappku na ploche‚Äú na iPhone, otvor v Safari ‚Üí <b>Zdieƒæa≈•</b> ‚Üí <b>Prida≈• na plochu</b>.
          </div>
        </div>
      </div>

      <!-- RIGHT: QUIZ -->
      <div class="card" id="quizCard">
        <div class="hd">
          <h2 id="quizTitle">Vyber predmet a t√©mu</h2>
          <span class="badge" id="quizBadge">‚Äî</span>
        </div>
        <div class="bd">
          <div class="progress" aria-label="Progress">
            <div class="bar" id="progressBar"></div>
          </div>

          <div class="metaRow">
            <span class="pill">Ot√°zka: <b id="qIndex">‚Äî</b></span>
            <span class="pill">Body: <b id="scoreNow">0</b></span>
            <span class="pill">Mo≈ænost√≠: <b id="lettersNow">A‚ÄìH</b></span>
          </div>

          <h3 class="qTitle" id="qText">Tu sa zobraz√≠ ot√°zka.</h3>
          <div id="choices" class="choices"></div>

          <div class="hr"></div>
          <div class="btnRow">
            <button class="btn primary" id="checkBtn" onclick="checkAndNext()" disabled>Skontrolova≈• & ƒèalej</button>
            <button class="btn" id="skipBtn" onclick="skipQuestion()" disabled>Preskoƒçi≈•</button>
            <button class="btn good" id="finishBtn" onclick="finishQuiz()" disabled>Vyhodnoti≈•</button>
          </div>

          <div id="resultWrap" style="display:none; margin-top:14px;">
            <div class="resultBox">
              <div class="resultGrid">
                <div class="stat">
                  <div class="k">Z√≠skan√© body</div>
                  <div class="v" id="finalScore">0</div>
                </div>
                <div class="stat">
                  <div class="k">√öspe≈°nos≈•</div>
                  <div class="v" id="finalPct">0%</div>
                </div>
                <div class="stat">
                  <div class="k">Ot√°zok spolu</div>
                  <div class="v" id="finalCount">0</div>
                </div>
                <div class="stat">
                  <div class="k">Re≈æim</div>
                  <div class="v" id="finalMode">8 mo≈ænost√≠</div>
                </div>
              </div>
              <div class="hr"></div>
              <div id="finalBadgeRow"></div>
              <div class="hr"></div>
              <div class="btnRow">
                <button class="btn primary" onclick="restartSameTheme()">Znova t√∫to t√©mu</button>
                <button class="btn" onclick="goBackToThemes()">Vybra≈• in√∫ t√©mu</button>
              </div>
              <div class="hint" style="margin-top:10px">
                Bodovanie: za ka≈æd√∫ ot√°zku dostane≈° <b>bod za ka≈æd√∫ spr√°vne oznaƒçen√∫ mo≈ænos≈•</b>.
                Ak ot√°zka m√° napr. 4 spr√°vne mo≈ænosti a oznaƒç√≠≈° 3 z nich, z√≠ska≈° <b>3 body</b>.
                (T. j. ‚Äûƒçiastoƒçn√© body‚Äú ako na prij√≠maƒçk√°ch.)
              </div>
            </div>
          </div>

          <div class="footer">
            Ovl√°danie: <span class="kbd">Tap</span> na mo≈ænosti ¬∑ <span class="kbd">Skontrolova≈• & ƒèalej</span> pokraƒçuje ¬∑ <span class="kbd">Vyhodnoti≈•</span> ukonƒç√≠.
          </div>
        </div>
      </div>
    </div>
  </div>

<script>
/**
 * ============================
 * 1) SEM VLO≈Ω√ç≈† OT√ÅZKY (JEDIN√â MIESTO)
 * ============================
 *
 * Form√°t jednej ot√°zky:
 * {
 *   id: 116,                         // ƒç√≠slo ot√°zky (voliteƒæn√©, ale odpor√∫ƒçam)
 *   text: "116. ...",
 *   choices: { A:"...", B:"...", ... H:"..." },  // 8 mo≈ænost√≠ (A‚ÄìH)
 *   correct: ["C","D","E"]           // spr√°vne p√≠smen√°
 * }
 *
 * Ak chce≈° ot√°zku len s 4 mo≈ænos≈•ami, m√¥≈æe≈° aj tak da≈• A‚ÄìH a prep√≠naƒç re≈æimu urob√≠ v√Ωber.
 */
const QUESTION_BANK = {
  bio: {
    name: "Biol√≥gia",
    themes: [
      { key:"bio_struktura_1_115", name:"≈†trukt√∫ra a delenie bunky (1‚Äì115)", questions: [
        // üîΩ TU VLO≈Ω√ç≈† OT√ÅZKY 1‚Äì115
        // { id:1, text:"1. ...", choices:{A:"...",B:"...",C:"...",D:"...",E:"...",F:"...",G:"...",H:"..."}, correct:["A","C"] },
      ]},
      { key:"bio_mikro_116_152", name:"Bunka a mikroorganizmy (116‚Äì152)", questions: [
        // üîΩ TU VLO≈Ω√ç≈† OT√ÅZKY 116‚Äì152
      ]},
      { key:"bio_fyzio_rastlin_153_250", name:"Fyziol√≥gia rastl√≠n (153‚Äì250)", questions: [] },
      { key:"bio_fyzio_ziv_I_251_349", name:"Fyziol√≥gia ≈æivoƒç√≠chov I. (251‚Äì349)", questions: [] },
      { key:"bio_fyzio_ziv_II_350_450", name:"Fyziol√≥gia ≈æivoƒç√≠chov II. (350‚Äì450)", questions: [] },
      { key:"bio_sustavy_I_451_617", name:"S√∫stavy ƒçloveka I. (451‚Äì617)", questions: [] },
      { key:"bio_sustavy_II_618_740", name:"S√∫stavy ƒçloveka II. (618‚Äì740)", questions: [] },
      { key:"bio_sustavy_III_741_900", name:"S√∫stavy ƒçloveka III. (741‚Äì900)", questions: [] },
      { key:"bio_gen_I_901_1006", name:"Genetika I. (901‚Äì1006)", questions: [] },
      { key:"bio_gen_II_1007_1119", name:"Genetika II. (1007‚Äì1119)", questions: [] },
      { key:"bio_gen_III_1120_1250", name:"Genetika III. (1120‚Äì1250)", questions: [] },
      { key:"bio_system_1251_1500", name:"Syst√©m rastl√≠n a ≈æivoƒç√≠chov, ekol√≥gia, evol√∫cia (1251‚Äì1500)", questions: [] },
      { key:"bio_opakovanie_1_1500", name:"OPAKOVANIE (1‚Äì1500)", questions: [] },
    ]
  },
  chem: {
    name: "Ch√©mia",
    themes: [
      { key:"chem_zaklady_1_110", name:"Z√°kladn√© pojmy a n√°zvoslovie (1‚Äì110)", questions: [] },
      { key:"chem_atom_111_160", name:"Stavba at√≥mu (111‚Äì160)", questions: [] },
      { key:"chem_vazby_161_210", name:"Chemick√© v√§zby (161‚Äì210)", questions: [] },
      { key:"chem_kinetika_211_260", name:"Fyzik√°lna ch√©mia ‚Äì kinetika (211‚Äì260)", questions: [] },
      { key:"chem_kyseliny_261_315", name:"Kyseliny a z√°sady (261‚Äì315)", questions: [] },
      { key:"chem_reakcie_316_390", name:"Chemick√© reakcie (316‚Äì390)", questions: [] },
      { key:"chem_anorg_391_470", name:"Anorganick√° ch√©mia ‚Äì prvky (391‚Äì470)", questions: [] },
      { key:"chem_uhlov_641_790", name:"Uhƒæovod√≠ky (641‚Äì790)", questions: [] },
      { key:"chem_deriv_791_940", name:"Deriv√°ty uhƒæovod√≠kov (791‚Äì940)", questions: [] },
      { key:"chem_karb_941_1040", name:"Karboxylov√© kyseliny (941‚Äì1040)", questions: [] },
      { key:"chem_hetero_1040_1195", name:"Heterocykly, polym√©ry, lipidy (1040‚Äì1195)", questions: [] },
      { key:"chem_sachar_1196_1350", name:"Sacharidy, bielkoviny, aminokyseliny (1196‚Äì1350)", questions: [] },
      { key:"chem_nukleo_1351_1500", name:"Nukleov√© kyseliny, bioch√©mia (1351‚Äì1500)", questions: [] },
      { key:"chem_opakovanie_1_1500", name:"OPAKOVANIE (1‚Äì1500)", questions: [] },
    ]
  }
};

/**
 * ============================
 * 2) APLIK√ÅCIA ‚Äì LOGIKA
 * ============================
 */
const LETTERS_8 = ["A","B","C","D","E","F","G","H"];
const LETTERS_4 = ["A","B","C","D"];

let mode8 = true; // true = 8 mo≈ænost√≠, false = 4 mo≈ænosti
let navLevel = "subject"; // subject | theme | quiz | result
let currentSubjectKey = null; // 'bio'|'chem'
let currentThemeKey = null;
let quiz = null;

function $(id){ return document.getElementById(id); }

function setModeUI(){
  const switchEl = $("modeSwitch");
  const label = $("modeLabel");
  const lettersNow = $("lettersNow");
  if(mode8){
    switchEl.classList.add("on");
    switchEl.setAttribute("aria-checked","true");
    label.textContent = "Re≈æim: 8 mo≈ænost√≠";
    lettersNow.textContent = "A‚ÄìH";
  } else {
    switchEl.classList.remove("on");
    switchEl.setAttribute("aria-checked","false");
    label.textContent = "Re≈æim: 4 mo≈ænosti";
    lettersNow.textContent = "A‚ÄìD";
  }
}

function buildSubjectScreen(){
  $("navTitle").textContent = "Menu";
  $("navBadge").textContent = "Pripraven√©";
  $("crumbs").innerHTML = 'Si tu: <b>Predmet</b>';
  $("backBtn").style.display = "none";

  const box = $("screenSubject");
  box.style.display = "";
  $("screenThemes").style.display = "none";

  box.innerHTML = "";
  [
    { key:"bio", icon:"üß¨" },
    { key:"chem", icon:"‚öóÔ∏è" }
  ].forEach(s=>{
    const subj = QUESTION_BANK[s.key];
    const div = document.createElement("div");
    div.className = "item";
    div.onclick = ()=>openSubject(s.key);
    div.innerHTML = `
      <div>
        <div class="t">${s.icon} ${subj.name}</div>
        <div class="s">${subj.themes.length} t√©m</div>
      </div>
      <div class="badge">Vybra≈•</div>
    `;
    box.appendChild(div);
  });

  setQuizIdle();
  navLevel = "subject";
}

function openSubject(subjectKey){
  currentSubjectKey = subjectKey;
  currentThemeKey = null;
  navLevel = "theme";

  const subj = QUESTION_BANK[subjectKey];
  $("navTitle").textContent = subj.name;
  $("navBadge").textContent = "T√©my";
  $("crumbs").innerHTML = `Si tu: <b>Predmet</b> ‚Üí <b>${subj.name}</b>`;
  $("backBtn").style.display = "";

  $("screenSubject").style.display = "none";
  const list = $("screenThemes");
  list.style.display = "";
  list.innerHTML = "";

  subj.themes.forEach(t=>{
    const count = (t.questions || []).length;
    const div = document.createElement("div");
    div.className = "item";
    div.onclick = ()=>startThemeQuiz(subjectKey, t.key);
    div.innerHTML = `
      <div>
        <div class="t">${t.name}</div>
        <div class="s">${count} ot√°zok</div>
      </div>
      <div class="badge">${count ? "Spusti≈•" : "Pr√°zdne"}</div>
    `;
    list.appendChild(div);
  });

  setQuizIdle(subj.name);
}

function goBack(){
  if(navLevel === "theme"){ buildSubjectScreen(); return; }
  if(navLevel === "quiz" || navLevel === "result"){ goBackToThemes(); return; }
  buildSubjectScreen();
}

function hardReset(){
  // len reset UI stavu (bez vymazania ot√°zok)
  quiz = null;
  currentSubjectKey = null;
  currentThemeKey = null;
  $("resultWrap").style.display = "none";
  $("quizBadge").textContent = "‚Äî";
  $("finalBadgeRow").innerHTML = "";
  buildSubjectScreen();
}

function setQuizIdle(subjName){
  $("quizTitle").textContent = subjName ? `${subjName} ¬∑ vyber t√©mu` : "Vyber predmet a t√©mu";
  $("quizBadge").textContent = "‚Äî";
  $("qIndex").textContent = "‚Äî";
  $("scoreNow").textContent = "0";
  $("qText").textContent = "Tu sa zobraz√≠ ot√°zka.";
  $("choices").innerHTML = "";
  $("progressBar").style.width = "0%";
  $("checkBtn").disabled = true;
  $("skipBtn").disabled = true;
  $("finishBtn").disabled = true;
  $("resultWrap").style.display = "none";
}

/**
 * ============================
 * 3) KV√çZ (mie≈°anie v r√°mci t√©my, nie naprieƒç t√©mami)
 * ============================
 */
function startThemeQuiz(subjectKey, themeKey){
  const subj = QUESTION_BANK[subjectKey];
  const theme = subj.themes.find(t=>t.key===themeKey);
  currentThemeKey = themeKey;

  // V opakovan√≠ chce≈° mix, ale v r√°mci t√©my chce≈° tie≈æ mie≈°a≈• (len vn√∫tri t√©my).
  // Tu mie≈°ame V≈ΩDY len ot√°zky z vybranej t√©my.
  const original = (theme.questions || []).slice();
  const shuffled = shuffle(original);

  quiz = {
    subjectKey,
    themeKey,
    themeName: theme.name,
    questions: shuffled,
    i: 0,
    score: 0,
    maxScore: 0, // s√∫ƒçet poƒçtu spr√°vnych mo≈ænost√≠ podƒæa re≈æimu (4/8)
    answered: 0
  };

  // maxScore poƒç√≠tame podƒæa re≈æimu (ak re≈æim 4, tak sa ber√∫ len A‚ÄìD a aj correct sa filtruje)
  quiz.maxScore = shuffled.reduce((sum, q)=> sum + getCorrectLetters(q).length, 0);

  navLevel = "quiz";
  $("quizTitle").textContent = theme.name;
  $("quizBadge").textContent = "Test";
  $("resultWrap").style.display = "none";

  $("checkBtn").disabled = shuffled.length === 0;
  $("skipBtn").disabled = shuffled.length === 0;
  $("finishBtn").disabled = shuffled.length === 0;

  renderQuestion();
}

function getLetters(){
  return mode8 ? LETTERS_8 : LETTERS_4;
}

function getCorrectLetters(q){
  const allowed = new Set(getLetters());
  const corr = Array.isArray(q.correct) ? q.correct : [];
  return corr.filter(x=>allowed.has(x));
}

function getChoiceText(q, letter){
  // ak v re≈æime 4, st√°le pou≈æ√≠vame A‚ÄìD
  return (q.choices && q.choices[letter]) ? q.choices[letter] : "";
}

function renderQuestion(){
  const list = quiz.questions;
  const total = list.length;

  $("resultWrap").style.display = "none";

  if(total === 0){
    $("qIndex").textContent = "0 / 0";
    $("qText").textContent = "T√°to t√©ma zatiaƒæ nem√° ot√°zky. Najprv ich vlo≈æ do QUESTION_BANK.";
    $("choices").innerHTML = "";
    $("progressBar").style.width = "0%";
    $("checkBtn").disabled = true;
    $("skipBtn").disabled = true;
    $("finishBtn").disabled = true;
    return;
  }

  if(quiz.i >= total){
    finishQuiz();
    return;
  }

  const q = list[quiz.i];
  const letters = getLetters();

  $("qIndex").textContent = `${quiz.i+1} / ${total}`;
  $("scoreNow").textContent = `${quiz.score}`;
  $("progressBar").style.width = `${Math.round((quiz.i/total)*100)}%`;

  $("qText").textContent = q.text || "(ch√Ωba text ot√°zky)";

  const ch = $("choices");
  ch.innerHTML = "";

  letters.forEach(L=>{
    const txt = getChoiceText(q, L);
    const div = document.createElement("label");
    div.className = "choice" + (txt ? "" : " small");
    div.innerHTML = `
      <input type="checkbox" value="${L}" ${txt ? "" : "disabled"} />
      <div class="lbl">${L}</div>
      <div class="tx">${txt ? txt : "‚Äî (nevyplnen√©)"}</div>
    `;
    ch.appendChild(div);
  });
}

function readSelected(){
  const inputs = $("choices").querySelectorAll('input[type="checkbox"]');
  const picked = [];
  inputs.forEach(i=>{ if(i.checked) picked.push(i.value); });
  return picked;
}

/**
 * Bodovanie (ƒçiastoƒçn√© body):
 * +1 za ka≈æd√∫ spr√°vnu mo≈ænos≈•, ktor√∫ si oznaƒçila.
 * 0 bodov za nespr√°vne oznaƒçenia (≈æiadne m√≠nus body).
 * => ak spr√°vnych je 4 a oznaƒç√≠≈° 3 spr√°vne, m√°≈° 3 body.
 */
function scoreAnswer(selected, correct){
  const correctSet = new Set(correct);
  let pts = 0;
  selected.forEach(s=>{ if(correctSet.has(s)) pts += 1; });
  return pts;
}

function checkAndNext(){
  if(!quiz) return;

  const q = quiz.questions[quiz.i];
  const selected = readSelected();
  const correct = getCorrectLetters(q);

  const pts = scoreAnswer(selected, correct);
  quiz.score += pts;
  quiz.answered += 1;

  quiz.i += 1;
  renderQuestion();
}

function skipQuestion(){
  if(!quiz) return;
  quiz.i += 1;
  renderQuestion();
}

function finishQuiz(){
  if(!quiz) return;

  const totalQ = quiz.questions.length;
  const max = quiz.maxScore || 0;
  const got = quiz.score || 0;

  const pct = max > 0 ? Math.round((got / max) * 100) : 0;

  $("resultWrap").style.display = "";
  $("finalScore").textContent = `${got} / ${max}`;
  $("finalPct").textContent = `${pct}%`;
  $("finalCount").textContent = `${totalQ}`;
  $("finalMode").textContent = mode8 ? "8 mo≈ænost√≠ (A‚ÄìH)" : "4 mo≈ænosti (A‚ÄìD)";

  $("progressBar").style.width = "100%";
  $("qText").textContent = "Vyhodnotenie testu";
  $("choices").innerHTML = "";

  // badge
  $("finalBadgeRow").innerHTML = renderBadge(pct);

  $("checkBtn").disabled = true;
  $("skipBtn").disabled = true;
  $("finishBtn").disabled = true;

  navLevel = "result";
}

function renderBadge(pct){
  let cls = "warn", text = "Pokraƒçuj ƒèalej üí™";
  if(pct >= 85){ cls="good"; text="V√Ωborne! üî•"; }
  else if(pct >= 70){ cls="good"; text="Super! ‚úÖ"; }
  else if(pct >= 50){ cls="warn"; text="D√° sa, e≈°te dotiahnu≈•. ‚ú®"; }
  else { cls="bad"; text="Nevad√≠, sk√∫si≈• znova. üíô"; }
  return `<span class="badge ${cls}">${text}</span>`;
}

function restartSameTheme(){
  if(!quiz) return;
  startThemeQuiz(quiz.subjectKey, quiz.themeKey);
}

function goBackToThemes(){
  if(!currentSubjectKey) { buildSubjectScreen(); return; }
  openSubject(currentSubjectKey);
  $("resultWrap").style.display = "none";
  navLevel = "theme";
}

/**
 * ============================
 * 4) HELPERS
 * ============================
 */
function shuffle(arr){
  // Fisher‚ÄìYates
  const a = arr.slice();
  for(let i=a.length-1; i>0; i--){
    const j = Math.floor(Math.random() * (i+1));
    [a[i], a[j]] = [a[j], a[i]];
  }
  return a;
}

/**
 * ============================
 * 5) MODE SWITCH EVENTS
 * ============================
 */
function toggleMode(){
  mode8 = !mode8;
  setModeUI();

  // ak pr√°ve be≈æ√≠ test, prepoƒç√≠tame maxScore podƒæa nov√©ho re≈æimu a prekresl√≠me ot√°zku
  if(quiz){
    quiz.maxScore = quiz.questions.reduce((sum, q)=> sum + getCorrectLetters(q).length, 0);
    $("scoreNow").textContent = `${quiz.score}`;
    renderQuestion();
  }
}

$("modeSwitch").addEventListener("click", toggleMode);
$("modeSwitch").addEventListener("keydown", (e)=>{
  if(e.key === "Enter" || e.key === " "){
    e.preventDefault();
    toggleMode();
  }
});

setModeUI();
buildSubjectScreen();

/**
 * ============================
 * 6) (Voliteƒæn√©) R√Ωchla kontrola, ƒçi m√°≈° chybn√Ω form√°t ot√°zok
 * ============================
 * Ak by si vlo≈æila ot√°zku zle (ch√Ωba z√°tvorka/ƒçiarka), str√°nka by nabehne≈• nemusela.
 * Preto odpor√∫ƒçam vklada≈• ot√°zky po men≈°√≠ch d√°vkach.
 */
</script>
</body>
</html>
